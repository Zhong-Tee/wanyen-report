<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SalesPulse V.16 (Strict & Delete Tool)</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.min.js"></script>

    <style>
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: #f1f1f1; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }
        .group-card { transition: all 0.2s; }
        .group-card:hover { transform: translateY(-2px); box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1); }
    </style>
</head>
<body class="bg-slate-50 text-slate-800 font-sans min-h-screen">

    <nav class="bg-white shadow-sm border-b border-slate-200 sticky top-0 z-50">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-3 flex justify-between items-center">
            <div class="flex items-center gap-3">
                <div class="bg-indigo-600 text-white p-1.5 rounded-lg">
                    <svg class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" /></svg>
                </div>
                <div>
                    <h1 class="text-xl font-bold text-slate-900">SalesPulse</h1>
                    <p class="text-[10px] text-slate-500 uppercase tracking-widest">V.16 Strict & Smart Delete</p>
                </div>
            </div>
            <div class="flex items-center gap-3">
                <!-- New Delete Button -->
                <button id="deleteByFileBtn" class="px-3 py-1 bg-orange-100 text-orange-700 text-xs font-bold rounded hover:bg-orange-200 border border-orange-200 transition-colors flex items-center gap-1">
                    <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg>
                    Delete DATA (By File)
                </button>
                <!-- Hidden input for delete -->
                <input type="file" id="deleteFileInput" accept=".csv" class="hidden">

                <button id="resetDbBtn" class="px-3 py-1 bg-red-50 text-red-600 text-xs font-bold rounded hover:bg-red-100 border border-red-200 transition-colors">
                    RESET DB
                </button>
                <div id="dbStatus" class="flex items-center gap-2 px-3 py-1 bg-slate-100 rounded-full text-xs font-medium text-slate-500">
                    <div class="w-2 h-2 rounded-full bg-slate-400"></div> Connecting...
                </div>
            </div>
        </div>
    </nav>

    <main class="max-w-7xl mx-auto px-4 py-8 space-y-8">
        
        <!-- 1. IMPORT -->
        <section class="bg-white rounded-xl shadow-sm border border-slate-200 p-6">
            <h2 class="font-bold text-slate-900 mb-4 flex items-center gap-2">
                1. Import Data
            </h2>
            <div class="flex gap-4 items-center">
                <input type="file" id="csvFileInput" accept=".csv" multiple class="block w-full text-sm file:mr-4 file:py-2 file:px-4 file:rounded-lg file:border-0 file:bg-indigo-50 file:text-indigo-700 border rounded-lg cursor-pointer">
                <button id="importBtn" class="px-6 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 disabled:opacity-50 font-medium transition-all shadow-sm" disabled>Upload</button>
            </div>
            <!-- Unified Progress Bar -->
            <div id="progressBox" class="hidden mt-4">
                <div class="flex justify-between text-xs text-slate-500 mb-1"><span id="currentFileText">Processing...</span><span id="progressText">0%</span></div>
                <div class="w-full bg-slate-100 rounded-full h-2 overflow-hidden"><div id="progressBar" class="bg-indigo-500 h-2 rounded-full transition-all duration-300" style="width: 0%"></div></div>
                <p id="statusDetail" class="text-xs text-slate-400 mt-1"></p>
            </div>
        </section>

        <!-- 2. FILTER -->
        <section class="bg-white rounded-xl shadow-sm border border-slate-200 p-6">
            <div class="flex justify-between items-center mb-4">
                <h2 class="font-bold text-slate-900">2. Filter Data</h2>
                <span id="recordCountDisplay" class="text-xs font-mono bg-slate-100 px-2 py-1 rounded text-slate-600">Records: 0</span>
            </div>
            
            <div class="flex flex-wrap gap-4 items-end">
                <div><label class="block text-xs font-bold text-slate-500 mb-1">Start Date</label><input type="date" id="startDate" class="border p-2 rounded-lg text-sm outline-none focus:ring-2 focus:ring-indigo-500"></div>
                <div><label class="block text-xs font-bold text-slate-500 mb-1">End Date</label><input type="date" id="endDate" class="border p-2 rounded-lg text-sm outline-none focus:ring-2 focus:ring-indigo-500"></div>
                <button id="loadBtn" class="px-6 py-2 bg-slate-800 text-white rounded-lg hover:bg-slate-900 font-medium transition-all shadow-lg">
                    Refresh Data
                </button>
                <div class="flex gap-2 ml-auto">
                    <button onclick="setDateRange('1d')" class="px-3 py-1.5 bg-slate-50 border rounded text-xs font-medium hover:bg-slate-100">Today</button>
                    <button onclick="setDateRange('1m')" class="px-3 py-1.5 bg-slate-50 border rounded text-xs font-medium hover:bg-slate-100">This Month</button>
                    <button onclick="setDateRange('auto')" class="px-3 py-1.5 bg-indigo-50 text-indigo-700 border border-indigo-100 rounded text-xs font-bold hover:bg-indigo-100">Auto Max</button>
                </div>
            </div>
        </section>

        <!-- 3. MAIN DASHBOARD -->
        <div id="dashboard" class="space-y-8 opacity-50 pointer-events-none transition-opacity duration-500">
            
            <!-- Global KPIs -->
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                <div class="bg-gradient-to-br from-slate-800 to-slate-700 p-6 rounded-xl shadow-lg text-white">
                    <p class="text-sm font-medium opacity-80">Total Sales</p>
                    <p class="text-3xl font-bold mt-1" id="kpiSales">0.00</p>
                </div>
                <div class="bg-white p-6 rounded-xl shadow-sm border border-slate-200">
                    <p class="text-sm font-semibold text-slate-400">Total Quantity</p>
                    <p class="text-3xl font-bold text-slate-900 mt-1" id="kpiQty">0</p>
                </div>
                <div class="bg-white p-6 rounded-xl shadow-sm border border-slate-200">
                    <p class="text-sm font-semibold text-slate-400">Avg / Sheet</p>
                    <p class="text-3xl font-bold text-slate-900 mt-1" id="kpiAvg">0.00</p>
                </div>
            </div>

            <!-- Global Charts -->
            <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                <div class="lg:col-span-2 bg-white p-6 rounded-xl shadow-sm border border-slate-200">
                    <h3 class="font-bold mb-4">Sales Trend</h3>
                    <div class="h-64"><canvas id="mainChart"></canvas></div>
                </div>
                <div class="bg-white p-6 rounded-xl shadow-sm border border-slate-200 flex flex-col">
                    <h3 class="font-bold mb-4">Weekly Stats</h3>
                    <div class="h-40 mb-2"><canvas id="weeklyChart"></canvas></div>
                    <div class="flex-1 overflow-auto"><table class="w-full text-sm"><tbody id="weekTable"></tbody></table></div>
                </div>
            </div>

            <!-- GROUP ANALYSIS -->
            <div>
                <div class="flex items-center gap-2 mb-6 px-1 mt-8">
                    <svg class="w-6 h-6 text-indigo-600" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4" /></svg>
                    <h3 class="text-xl font-bold text-slate-800">Branch Group Analysis</h3>
                </div>

                <div class="grid grid-cols-1 xl:grid-cols-3 gap-8">
                    <!-- Moshi -->
                    <div class="bg-white rounded-xl shadow-sm border border-slate-200 overflow-hidden group-card flex flex-col">
                        <div class="bg-pink-50 px-6 py-4 border-b border-pink-100 flex justify-between items-center"><h4 class="font-bold text-pink-700">Moshi / MS</h4></div>
                        <div class="p-6 flex-1 flex flex-col gap-4">
                            <div class="grid grid-cols-2 gap-4">
                                <div><p class="text-xs text-slate-500">Sales</p><p class="text-xl font-bold text-slate-800" id="moshiSales">0</p></div>
                                <div><p class="text-xs text-slate-500">Avg</p><p class="text-xl font-bold text-slate-800" id="moshiAvg">0</p></div>
                            </div>
                            <div class="space-y-4 mt-2">
                                <div><p class="text-xs font-bold text-slate-400 uppercase mb-1">Top Products</p><table class="w-full text-xs"><tbody id="moshiProdTable"></tbody></table></div>
                                <div><p class="text-xs font-bold text-slate-400 uppercase mb-1">Top Branches</p><table class="w-full text-xs"><tbody id="moshiBranchTable"></tbody></table></div>
                            </div>
                        </div>
                    </div>
                    <!-- B2S -->
                    <div class="bg-white rounded-xl shadow-sm border border-slate-200 overflow-hidden group-card flex flex-col">
                        <div class="bg-blue-50 px-6 py-4 border-b border-blue-100 flex justify-between items-center"><h4 class="font-bold text-blue-700">B2S</h4></div>
                        <div class="p-6 flex-1 flex flex-col gap-4">
                            <div class="grid grid-cols-2 gap-4">
                                <div><p class="text-xs text-slate-500">Sales</p><p class="text-xl font-bold text-slate-800" id="b2sSales">0</p></div>
                                <div><p class="text-xs text-slate-500">Avg</p><p class="text-xl font-bold text-slate-800" id="b2sAvg">0</p></div>
                            </div>
                            <div class="space-y-4 mt-2">
                                <div><p class="text-xs font-bold text-slate-400 uppercase mb-1">Top Products</p><table class="w-full text-xs"><tbody id="b2sProdTable"></tbody></table></div>
                                <div><p class="text-xs font-bold text-slate-400 uppercase mb-1">Top Branches</p><table class="w-full text-xs"><tbody id="b2sBranchTable"></tbody></table></div>
                            </div>
                        </div>
                    </div>
                    <!-- Wanyen -->
                    <div class="bg-white rounded-xl shadow-sm border border-slate-200 overflow-hidden group-card flex flex-col">
                        <div class="bg-orange-50 px-6 py-4 border-b border-orange-100 flex justify-between items-center"><h4 class="font-bold text-orange-700">Wanyen / Others</h4></div>
                        <div class="p-6 flex-1 flex flex-col gap-4">
                            <div class="grid grid-cols-2 gap-4">
                                <div><p class="text-xs text-slate-500">Sales</p><p class="text-xl font-bold text-slate-800" id="wanyenSales">0</p></div>
                                <div><p class="text-xs text-slate-500">Avg</p><p class="text-xl font-bold text-slate-800" id="wanyenAvg">0</p></div>
                            </div>
                            <div class="space-y-4 mt-2">
                                <div><p class="text-xs font-bold text-slate-400 uppercase mb-1">Top Products</p><table class="w-full text-xs"><tbody id="wanyenProdTable"></tbody></table></div>
                                <div><p class="text-xs font-bold text-slate-400 uppercase mb-1">Top Branches</p><table class="w-full text-xs"><tbody id="wanyenBranchTable"></tbody></table></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Raw Data Inspector -->
            <section class="bg-white rounded-xl shadow-sm border border-slate-200 overflow-hidden">
                <div class="p-4 bg-slate-50 cursor-pointer font-bold text-sm flex justify-between items-center text-slate-700 hover:bg-slate-100" onclick="document.getElementById('rawDataBox').classList.toggle('hidden')">
                    <span>üîç Inspector: Last 50 Records</span>
                    <span class="text-slate-400">‚ñº</span>
                </div>
                <div id="rawDataBox" class="hidden overflow-x-auto">
                    <table class="w-full text-sm text-left text-slate-600">
                        <thead class="bg-slate-100 text-xs uppercase font-semibold text-slate-500">
                            <tr><th class="p-3">Date/Time</th><th class="p-3">Product</th><th class="p-3">Branch</th><th class="p-3 text-right">Total</th></tr>
                        </thead>
                        <tbody id="rawDataTableBody" class="divide-y divide-slate-100"></tbody>
                    </table>
                </div>
            </section>
        </div>
    </main>

    <script>
        const SUPABASE_URL = 'https://lgaobgxeybmlrbsjgnfh.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImxnYW9iZ3hleWJtbHJic2pnbmZoIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjQ3Nzk1OTYsImV4cCI6MjA4MDM1NTU5Nn0.rmGercp5u829OkeqzDq9R2wlR7lA3b2P4po2CZTXOZM';
        const TABLE = 'sales_records';
        const LOG_TABLE = 'upload_logs';

        let supabase, GLOBAL_DATA = [], charts = {};

        window.onload = async () => {
            supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
            const { count, error } = await supabase.from(TABLE).select('*', { count: 'exact', head: true });
            if(!error) {
                updateStatus(true, count);
                loadAllDataAndFilter();
            } else {
                updateStatus(false, error.message);
            }
        };

        function updateStatus(connected, msg) {
            const el = document.getElementById('dbStatus');
            if(connected) {
                el.innerHTML = `<div class="w-2 h-2 rounded-full bg-green-500"></div> Connected (${msg})`;
                el.className = "flex items-center gap-2 px-3 py-1 bg-green-50 rounded-full text-xs font-medium text-green-700 border border-green-200";
                document.getElementById('importBtn').disabled = false;
                document.getElementById('clearDataBtn').classList.remove('hidden');
            } else {
                el.innerHTML = `<div class="w-2 h-2 rounded-full bg-red-500"></div> Error`;
                el.className = "flex items-center gap-2 px-3 py-1 bg-red-50 rounded-full text-xs font-medium text-red-700 border border-red-200";
                alert(msg);
            }
        }

        // --- 1. STRICT IMPORT ---
        document.getElementById('importBtn').onclick = async () => {
            const files = document.getElementById('csvFileInput').files;
            if(!files.length) return alert("Select files");
            const btn = document.getElementById('importBtn');
            btn.disabled = true; 
            const progressBox = document.getElementById('progressBox');
            progressBox.classList.remove('hidden');

            for(let i=0; i<files.length; i++) {
                const file = files[i];
                const fileName = file.name;
                document.getElementById('currentFileText').innerText = `Checking: ${fileName}`;

                // Strict Check
                const { data: existing } = await supabase.from(LOG_TABLE).select('*').eq('filename', fileName).single();
                if (existing) {
                    alert(`‚ùå BLOCK: File "${fileName}" already exists! \n\nTo re-upload, please use 'Delete DATA' button to remove old data first.`);
                    document.getElementById('statusDetail').innerText = `Skipped: ${fileName}`;
                    continue; 
                }

                document.getElementById('currentFileText').innerText = `Uploading: ${fileName}`;
                await processImport(file);
            }
            
            alert("Process Complete!");
            GLOBAL_DATA = []; loadAllDataAndFilter();
            btn.disabled = false;
            setTimeout(() => progressBox.classList.add('hidden'), 3000);
        };

        function processImport(file) {
            return new Promise(resolve => {
                Papa.parse(file, {
                    header: false, skipEmptyLines: true,
                    complete: async (res) => {
                        const rows = res.data.map(transform).filter(r => r);
                        if(rows.length) {
                            const batch = 500;
                            for(let j=0; j<Math.ceil(rows.length/batch); j++) {
                                await supabase.from(TABLE).insert(rows.slice(j*batch, (j+1)*batch));
                                const pct = Math.round(((j+1)/(rows.length/batch))*100);
                                document.getElementById('progressBar').style.width = pct+"%";
                                document.getElementById('progressText').innerText = pct+"%";
                            }
                            // Log Success
                            await supabase.from(LOG_TABLE).insert({ filename: file.name, total_rows: rows.length });
                        }
                        resolve();
                    }
                });
            });
        }

        // --- 2. DELETE BY FILE ---
        document.getElementById('deleteByFileBtn').onclick = () => {
            document.getElementById('deleteFileInput').click();
        };

        document.getElementById('deleteFileInput').onchange = async (e) => {
            const file = e.target.files[0];
            if(!file) return;
            
            if(!confirm(`‚ö†Ô∏è Confirm DELETE data matching file: "${file.name}"?`)) return;

            const progressBox = document.getElementById('progressBox');
            progressBox.classList.remove('hidden');
            document.getElementById('progressBar').className = "bg-red-500 h-2 rounded-full transition-all duration-300";
            document.getElementById('currentFileText').innerText = `Scanning & Deleting: ${file.name}`;

            Papa.parse(file, {
                header: false, skipEmptyLines: true,
                complete: async (res) => {
                    const rows = res.data.map(transform).filter(r => r);
                    if(rows.length) {
                        // Delete in batches
                        const batchSize = 50; 
                        let deletedCount = 0;
                        
                        for(let j=0; j<Math.ceil(rows.length/batchSize); j++) {
                            const chunk = rows.slice(j*batchSize, (j+1)*batchSize);
                            
                            // Construct massive OR filter for precision delete
                            // We use match on: Date, Time, Branch, Product, Amount
                            const deletePromises = chunk.map(r => 
                                supabase.from(TABLE).delete().match({
                                    transaction_date: r.transaction_date,
                                    transaction_time: r.transaction_time,
                                    branch_name: r.branch_name,
                                    product: r.product,
                                    total_amount: r.total_amount
                                })
                            );
                            
                            await Promise.all(deletePromises);
                            
                            deletedCount += chunk.length;
                            const pct = Math.round((deletedCount / rows.length) * 100);
                            document.getElementById('progressBar').style.width = pct+"%";
                            document.getElementById('progressText').innerText = pct+"%";
                        }

                        // Remove from Log
                        await supabase.from(LOG_TABLE).delete().eq('filename', file.name);
                    }
                    alert("Deletion Complete!");
                    GLOBAL_DATA = []; loadAllDataAndFilter();
                    progressBox.classList.add('hidden');
                    document.getElementById('progressBar').className = "bg-indigo-500 h-2 rounded-full transition-all duration-300"; // Reset color
                    e.target.value = ''; // Reset input
                }
            });
        };

        function transform(row) {
            if(row.length < 11) return null;
            const dateTimeStr = (row[1]||"").trim();
            const [datePart, timePart] = dateTimeStr.split(" ");
            if(!datePart) return null;
            const dSplit = datePart.split("/");
            if(dSplit.length !== 3) return null;
            let y = parseInt(dSplit[2]); if(y>2400) y-=543;
            
            const isoDate = `${y}-${dSplit[1].padStart(2,'0')}-${dSplit[0].padStart(2,'0')}`;
            let timeStr = timePart || "00:00:00";
            timeStr = timeStr.split(':').map(t => t.padStart(2, '0')).join(':');
            const timestampStr = `${isoDate}T${timeStr}`;

            const qty = parseInt(row[9]||0);
            const total = parseFloat((row[10]||"0").replace(/,/g, ""));

            return {
                timestamp: new Date(timestampStr).toISOString(),
                transaction_date: isoDate,
                transaction_time: timeStr,
                product: (row[3]||"").trim(),
                quantity: qty,
                price_per_sheet: qty ? total/qty : 0,
                total_amount: total,
                payment_type: (row[11]||"").trim(),
                branch_name: (row[14]||"").trim()
            };
        }

        // --- 3. LOAD & RENDER ---
        async function loadAllDataAndFilter() {
            const btn = document.getElementById('loadBtn');
            if (GLOBAL_DATA.length > 0) { filterAndRender(); return; }

            btn.disabled = true; btn.innerHTML = `Fetching...`;
            document.body.style.cursor = 'wait';

            let allRows = [], from = 0, pageSize = 1000, keepFetching = true;
            try {
                while(keepFetching) {
                    const { data, error } = await supabase.from(TABLE).select('*').range(from, from + pageSize - 1).order('id', {ascending: true});
                    if (error) throw error;
                    if (data.length) { allRows = allRows.concat(data); from += pageSize; }
                    if (data.length < pageSize) keepFetching = false;
                }
                GLOBAL_DATA = allRows;
                document.getElementById('recordCountDisplay').innerText = `Records: ${GLOBAL_DATA.length}`;
                
                if(GLOBAL_DATA.length > 0) {
                    const dates = GLOBAL_DATA.map(r => r.transaction_date).sort();
                    document.getElementById('startDate').value = dates[0];
                    document.getElementById('endDate').value = dates[dates.length-1];
                }

                btn.innerHTML = "Refresh Data"; btn.disabled = false;
                document.body.style.cursor = 'default';
                document.getElementById('dashboard').classList.remove('opacity-50', 'pointer-events-none');
                filterAndRender();
            } catch (err) { alert(err.message); btn.disabled=false; }
        }

        function filterAndRender() {
            const sDate = document.getElementById('startDate').value;
            const eDate = document.getElementById('endDate').value;
            const data = GLOBAL_DATA.filter(r => r.transaction_date >= sDate && r.transaction_date <= eDate);
            processData(data);
        }

        function processData(data) {
            const global = { sum:0, count:0, daily:{}, weekly:[0,0,0,0,0,0,0] };
            const groups = {
                'Moshi': { sum:0, count:0, prod:{}, branch:{} },
                'B2S': { sum:0, count:0, prod:{}, branch:{} },
                'Wanyen': { sum:0, count:0, prod:{}, branch:{} }
            };

            data.forEach(r => {
                const val = Number(r.total_amount)||0;
                const qty = Number(r.quantity)||0;
                const prod = r.product || "Unknown";
                const branch = r.branch_name || "Unknown";
                
                global.sum += val; global.count += qty;
                global.daily[r.transaction_date] = (global.daily[r.transaction_date]||0) + val;
                global.weekly[new Date(r.timestamp).getDay()] += val;

                let grp = 'Wanyen';
                const bUp = branch.toUpperCase();
                if(bUp.includes('MOSHI') || bUp.includes('MS')) grp = 'Moshi';
                else if(bUp.includes('B2S')) grp = 'B2S';

                const g = groups[grp];
                g.sum += val; g.count += qty;
                if(!g.prod[prod]) g.prod[prod] = 0; g.prod[prod] += val;
                if(!g.branch[branch]) g.branch[branch] = 0; g.branch[branch] += val;
            });

            const cur = new Intl.NumberFormat('en-US', {style:'currency', currency:'THB'});
            const num = new Intl.NumberFormat('en-US');

            document.getElementById('kpiSales').innerText = cur.format(global.sum);
            document.getElementById('kpiQty').innerText = num.format(global.count);
            document.getElementById('kpiAvg').innerText = cur.format(global.count ? global.sum/global.count : 0);
            
            renderCharts(global.daily, global.weekly);

            ['Moshi', 'B2S', 'Wanyen'].forEach(k => {
                const prefix = k.toLowerCase();
                const g = groups[k];
                document.getElementById(prefix+'Sales').innerText = cur.format(g.sum);
                document.getElementById(prefix+'Avg').innerText = cur.format(g.count ? g.sum/g.count : 0);
                
                const mkTable = (obj) => Object.entries(obj).sort((a,b)=>b[1]-a[1]).slice(0,5).map(([n,v]) => 
                    `<tr class="border-b border-slate-50"><td class="py-1 truncate max-w-[120px]" title="${n}">${n}</td><td class="text-right font-mono">${cur.format(v)}</td></tr>`
                ).join('');
                document.getElementById(prefix+'ProdTable').innerHTML = mkTable(g.prod);
                document.getElementById(prefix+'BranchTable').innerHTML = mkTable(g.branch);
            });
            
            document.getElementById('rawDataTableBody').innerHTML = data.slice(0,50).map(r => 
                `<tr class="border-b hover:bg-slate-50"><td class="p-3">${r.transaction_date} ${r.transaction_time}</td><td class="p-3 truncate max-w-[150px]">${r.product}</td><td class="p-3 truncate max-w-[150px]">${r.branch_name}</td><td class="p-3 text-right">${r.quantity}</td><td class="p-3 text-right font-mono">${cur.format(r.total_amount)}</td></tr>`
            ).join('');
        }

        function renderCharts(daily, weekly) {
            const days = Object.keys(daily).sort();
            const dData = days.map(d => daily[d]);
            
            if(charts.main) charts.main.destroy();
            charts.main = new Chart(document.getElementById('mainChart'), {
                type: 'line',
                data: { labels: days, datasets: [{ label: 'Sales', data: dData, borderColor: '#2563eb', backgroundColor: 'rgba(37, 99, 235, 0.1)', fill: true }] },
                options: { responsive:true, maintainAspectRatio:false, plugins:{legend:{display:false}}, scales:{y:{beginAtZero:true}} }
            });

            const wLabels = ["Sun","Mon","Tue","Wed","Thu","Fri","Sat"];
            const rotData = [...weekly.slice(1), weekly[0]];
            const rotLabels = [...wLabels.slice(1), wLabels[0]];

            if(charts.week) charts.week.destroy();
            charts.week = new Chart(document.getElementById('weeklyChart'), {
                type: 'bar',
                data: { labels: rotLabels, datasets: [{ data: rotData, backgroundColor: '#10b981', borderRadius: 4 }] },
                options: { responsive:true, maintainAspectRatio:false, plugins:{legend:{display:false}}, scales:{x:{grid:{display:false}}} }
            });

            document.getElementById('weekTable').innerHTML = rotLabels.map((d, i) => 
                `<tr class="border-b"><td class="py-1 text-slate-600">${d}</td><td class="text-right font-mono">${new Intl.NumberFormat('en-US', {style:'currency', currency:'THB'}).format(rotData[i])}</td></tr>`
            ).join('');
        }

        document.getElementById('resetDbBtn').onclick = async () => {
            if(!confirm("WARNING: This will delete ALL data in the database. Are you sure?")) return;
            await supabase.from(TABLE).delete().neq('id', 0);
            await supabase.from(LOG_TABLE).delete().neq('id', 0);
            GLOBAL_DATA = []; loadAllDataAndFilter();
            alert("Database Reset Complete");
        };

        function setDateRange(mode) {
            const d = new Date();
            if(mode === 'auto' && GLOBAL_DATA.length) {
                const dates = GLOBAL_DATA.map(r => r.transaction_date).sort();
                document.getElementById('startDate').value = dates[0];
                document.getElementById('endDate').value = dates[dates.length-1];
            } else if(mode === '1d') {
                const today = d.toISOString().split('T')[0];
                document.getElementById('startDate').value = today;
                document.getElementById('endDate').value = today;
            } else if(mode === '1m') {
                const end = d.toISOString().split('T')[0];
                d.setMonth(d.getMonth()-1);
                const start = d.toISOString().split('T')[0];
                document.getElementById('startDate').value = start;
                document.getElementById('endDate').value = end;
            }
            if(GLOBAL_DATA.length) filterAndRender();
        }
        
        document.getElementById('loadBtn').onclick = () => { GLOBAL_DATA.length ? filterAndRender() : loadAllDataAndFilter(); };
    </script>
</body>
</html>
